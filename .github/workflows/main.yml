name: MiHoYo Auto Check-in

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 23:20 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 7:20ï¼‰
    - cron: '20 23 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push: # å½“æœ‰ä»£ç æŽ¨é€æ—¶ä¹Ÿè¿è¡Œï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
    branches: [ main ]

jobs:
  check-in:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. ä¸‹è½½ä»£ç 
        uses: actions/checkout@v3

      - name: 2. è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 3. å®‰è£…æ‰€éœ€è½¯ä»¶åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: 4. åˆ›å»ºç­¾åˆ°è„šæœ¬
        run: |
          cat > checkin.py << 'EOF'
          #!/usr/bin/env python3
          # -*- coding: utf-8 -*-
          
          import os
          import sys
          import json
          import time
          import requests
          from datetime import datetime
          
          # ç”¨æˆ·ä»£ç†ï¼Œæ¨¡æ‹Ÿæµè§ˆå™¨
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'application/json, text/plain, */*',
              'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
              'Content-Type': 'application/json;charset=UTF-8',
              'Origin': 'https://webstatic.mihoyo.com',
              'Referer': 'https://webstatic.mihoyo.com/'
          }
          
          def log_print(message):
              """æ‰“å°å¸¦æ—¶é—´çš„æ—¥å¿—"""
              current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
              print(f"[{current_time}] {message}")
              sys.stdout.flush()
          
          def check_mihoyo_cookie(cookie):
              """æ£€æŸ¥ç±³æ¸¸ç¤¾Cookieæ˜¯å¦æœ‰æ•ˆ"""
              url = "https://api-takumi.mihoyo.com/binding/api/getUserGameRolesByCookie"
              headers = HEADERS.copy()
              headers['Cookie'] = cookie
              
              try:
                  response = requests.get(url, headers=headers, timeout=15)
                  if response.status_code == 200:
                      data = response.json()
                      if data.get('retcode') == 0:
                          roles = data.get('data', {}).get('list', [])
                          return True, roles
                  return False, []
              except Exception as e:
                  log_print(f"æ£€æŸ¥Cookieå¤±è´¥: {str(e)}")
                  return False, []
          
          def genshin_sign_in(token, uid="", region="cn_gf01"):
              """åŽŸç¥žç­¾åˆ°"""
              url = "https://sg-hk4e-api.hoyolab.com/event/sol/sign"
              headers = HEADERS.copy()
              
              # æž„å»ºcookie
              cookie_str = f"ltoken={token}; ltuid={uid}" if uid else f"ltoken={token}"
              headers['Cookie'] = cookie_str
              
              params = {
                  'act_id': 'e202102251931481',
                  'lang': 'zh-cn'
              }
              
              try:
                  response = requests.post(url, headers=headers, params=params, timeout=15)
                  if response.status_code == 200:
                      data = response.json()
                      message = data.get('message', 'æœªçŸ¥çŠ¶æ€')
                      retcode = data.get('retcode', -1)
                      
                      if retcode == 0:
                          log_print(f"âœ… åŽŸç¥žç­¾åˆ°æˆåŠŸ: {message}")
                      else:
                          log_print(f"âš ï¸ åŽŸç¥žç­¾åˆ°: {message} (retcode: {retcode})")
                      return data
                  else:
                      log_print(f"âŒ åŽŸç¥žç­¾åˆ°å¤±è´¥: HTTP {response.status_code}")
                      return None
              except Exception as e:
                  log_print(f"âŒ åŽŸç¥žç­¾åˆ°å¼‚å¸¸: {str(e)}")
                  return None
          
          def starrail_sign_in(token, uid="", region="prod_gf_cn"):
              """å´©åï¼šæ˜Ÿç©¹é“é“ç­¾åˆ°"""
              url = "https://sg-public-api.hoyolab.com/event/luna/os/sign"
              headers = HEADERS.copy()
              
              # æž„å»ºcookie
              cookie_str = f"ltoken={token}; ltuid={uid}" if uid else f"ltoken={token}"
              headers['Cookie'] = cookie_str
              
              json_data = {
                  'act_id': 'e202303301540311',
                  'lang': 'zh-cn',
                  'uid': uid,
                  'region': region
              }
              
              try:
                  response = requests.post(url, headers=headers, json=json_data, timeout=15)
                  if response.status_code == 200:
                      data = response.json()
                      message = data.get('message', 'æœªçŸ¥çŠ¶æ€')
                      retcode = data.get('retcode', -1)
                      
                      if retcode == 0:
                          log_print(f"âœ… æ˜Ÿç©¹é“é“ç­¾åˆ°æˆåŠŸ: {message}")
                      else:
                          log_print(f"âš ï¸ æ˜Ÿç©¹é“é“ç­¾åˆ°: {message} (retcode: {retcode})")
                      return data
                  else:
                      log_print(f"âŒ æ˜Ÿç©¹é“é“ç­¾åˆ°å¤±è´¥: HTTP {response.status_code}")
                      return None
              except Exception as e:
                  log_print(f"âŒ æ˜Ÿç©¹é“é“ç­¾åˆ°å¼‚å¸¸: {str(e)}")
                  return None
          
          def main():
              log_print("ðŸŽ® å¼€å§‹ç±³å“ˆæ¸¸è‡ªåŠ¨ç­¾åˆ°ä»»åŠ¡")
              log_print("=" * 50)
              
              # 1. ç±³æ¸¸ç¤¾Cookieç­¾åˆ°
              mys_cookies = os.getenv('MYS_COOKIES', '')
              if mys_cookies:
                  cookies = [c.strip() for c in mys_cookies.split(',') if c.strip()]
                  log_print(f"ðŸ“± æ‰¾åˆ° {len(cookies)} ä¸ªç±³æ¸¸ç¤¾è´¦å·")
                  
                  for idx, cookie in enumerate(cookies, 1):
                      log_print(f"ðŸ” æ£€æŸ¥ç¬¬ {idx} ä¸ªç±³æ¸¸ç¤¾è´¦å·...")
                      valid, roles = check_mihoyo_cookie(cookie)
                      if valid:
                          log_print(f"   âœ… è´¦å·æœ‰æ•ˆï¼Œæœ‰ {len(roles)} ä¸ªæ¸¸æˆè§’è‰²")
                          for role in roles:
                              game_name = role.get('game_biz', '')
                              role_name = role.get('nickname', 'æœªçŸ¥')
                              log_print(f"   ðŸŽ® {game_name}: {role_name}")
                      else:
                          log_print("   âŒ Cookieæ— æ•ˆæˆ–å·²è¿‡æœŸ")
                      time.sleep(1)
              else:
                  log_print("ðŸ“± æœªé…ç½®ç±³æ¸¸ç¤¾Cookie")
              
              log_print("-" * 50)
              
              # 2. åŽŸç¥žç­¾åˆ°
              genshin_tokens = os.getenv('GENSHIN_TOKENS', '')
              if genshin_tokens:
                  tokens = [t.strip() for t in genshin_tokens.split(',') if t.strip()]
                  log_print(f"ðŸŒ æ‰¾åˆ° {len(tokens)} ä¸ªåŽŸç¥žè´¦å·")
                  
                  for idx, token in enumerate(tokens, 1):
                      log_print(f"ðŸ”„ å¼€å§‹ç¬¬ {idx} ä¸ªåŽŸç¥žè´¦å·ç­¾åˆ°...")
                      genshin_sign_in(token)
                      if idx < len(tokens):  # ä¸æ˜¯æœ€åŽä¸€ä¸ªå°±ç­‰å¾…
                          time.sleep(3)
              else:
                  log_print("ðŸŒ æœªé…ç½®åŽŸç¥žToken")
              
              log_print("-" * 50)
              
              # 3. æ˜Ÿç©¹é“é“ç­¾åˆ°
              starrail_tokens = os.getenv('STARRAIL_TOKENS', '')
              if starrail_tokens:
                  tokens = [t.strip() for t in starrail_tokens.split(',') if t.strip()]
                  log_print(f"ðŸš€ æ‰¾åˆ° {len(tokens)} ä¸ªæ˜Ÿç©¹é“é“è´¦å·")
                  
                  for idx, token in enumerate(tokens, 1):
                      log_print(f"ðŸ”„ å¼€å§‹ç¬¬ {idx} ä¸ªæ˜Ÿç©¹é“é“è´¦å·ç­¾åˆ°...")
                      starrail_sign_in(token)
                      if idx < len(tokens):  # ä¸æ˜¯æœ€åŽä¸€ä¸ªå°±ç­‰å¾…
                          time.sleep(3)
              else:
                  log_print("ðŸš€ æœªé…ç½®æ˜Ÿç©¹é“é“Token")
              
              log_print("=" * 50)
              log_print("ðŸŽ‰ æ‰€æœ‰ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼")
          
          if __name__ == '__main__':
              main()
          EOF

      - name: 5. è¿è¡Œç­¾åˆ°è„šæœ¬
        env:
          MYS_COOKIES: ${{ secrets.MYS_COOKIES }}
          GENSHIN_TOKENS: ${{ secrets.GENSHIN_TOKENS }}
          STARRAIL_TOKENS: ${{ secrets.STARRAIL_TOKENS }}
        run: python checkin.py

      - name: 6. å®Œæˆæç¤º
        run: echo "âœ… ç­¾åˆ°ä»»åŠ¡å·²å®Œæˆï¼ä¸‹æ¬¡è¿è¡Œæ—¶é—´ï¼šåŒ—äº¬æ—¶é—´ 7:20"
